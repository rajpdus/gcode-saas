# Agent Plan: Step 6 - Prepare for Deployment

## 1. Goal

To assemble all generated artifacts (frontend code, backend code, CloudFormation templates for all infrastructure) into a final, deployable package following an opinionated structure, providing necessary configuration management, local development setup, and deployment scripts/instructions.

## 2. Input

*   Final Backend Application Source Code (Chalice project, potential indexer Lambda from Step 5)
*   Final Frontend Application Source Code (React project from Step 5)
*   All CloudFormation Snippets generated by various agents (`DatabaseAgent`, `AuthAgent`, `InfrastructureAgent` for IAM, S3, CloudFront, etc.)
*   **OpenSearch Requirement Flag** (from Step 3)

## 3. Opinionated Project Structure

The final generated project MUST adhere to the following directory structure:

```
/
├── backend/             # Chalice project root
│   ├── app.py
│   ├── chalicelib/
│   ├── requirements.txt
│   └── ... (other Chalice files)
├── frontend/            # React project root
│   ├── public/
│   ├── src/
│   ├── package.json
│   └── ... (other React files)
├── infrastructure/
│   ├── template.yaml    # Master CloudFormation template
│   ├── parameters/      # Environment-specific parameters (optional)
│   │   ├── dev.json
│   │   └── prod.json
│   └── (optional) modules/ # Nested stacks or modules
├── scripts/
│   ├── deploy.sh        # Main deployment script
│   ├── seed.sh          # Placeholder for data seeding (optional)
│   └── ... (other helper scripts)
├── tests/
│   ├── backend/         # Backend tests (unit, integration stubs)
│   └── frontend/        # Frontend tests (component stubs)
├── .env.example         # Example environment variables for local dev
├── .gitignore
├── README.md
└── samconfig.toml       # Configuration for AWS SAM CLI (local dev)
```

*(Note: If OpenSearch indexer Lambda is separate, it might live in `backend/lambda/indexer/` or a top-level `lambdas/indexer/`)*

## 4. Primary Agent(s) Involved

*   **`OrchestratorAgent`**: Manages the final assembly and packaging into the defined structure.
*   **`InfrastructureAgent`**: Assembles CFN template, generates deployment/local dev scripts & configs.
*   **`FrontendAgent`**: Provides build command.
*   **`BackendAgent`**: Provides packaging/deployment info for Chalice/indexer.

## 5. Process / Workflow

1.  **Artifact Collection & Structuring:** `OrchestratorAgent` gathers all final artifacts and organizes them into the defined project structure (creating directories as needed).
2.  **CloudFormation Assembly (`InfrastructureAgent`)**:
    *   Aggregates all CloudFormation snippets (DynamoDB, Cognito, IAM Roles, S3 Bucket, CloudFront Distribution, etc.) into `infrastructure/template.yaml`.
    *   **OpenSearch Resources (Conditional):** Includes conditional OpenSearch resources if flagged.
    *   **CI/CD Pipeline Definition:** Generates CloudFormation resources for a basic AWS CodePipeline:
        *   Source Stage (e.g., connected to CodeCommit, or placeholder for S3/GitHub/Bitbucket source action).
        *   Build Stage (using AWS CodeBuild).
            *   Defines a CodeBuild project that uses an AWS-provided build image (e.g., standard Linux image with Python/Node.js).
            *   The `buildspec.yml` (defined inline or separately) will reference the generated `scripts/deploy.sh` or contain similar commands (install deps, build frontend, package backend, deploy CFN, invalidate cache) for different environments based on pipeline triggers (e.g., branch names like `main` for prod, `develop` for dev).
        *   (Optional) Manual Approval stage for production deployments.
    *   Ensures proper parameterization for environment names, domain names, config values, pipeline source details.
    *   **CORS Configuration:** Ensures CloudFront forwards necessary CORS headers.
    *   Validates the final template (`aws cloudformation validate-template`).
3.  **Environment Configuration (`InfrastructureAgent`)**:
    *   Generates `infrastructure/parameters/dev.json` and `infrastructure/parameters/prod.json`.
    *   Generates `.env.example` for local development variables.
4.  **Local Development Setup (`InfrastructureAgent`)**:
    *   Generates a basic `samconfig.toml` for `sam build` / `sam local`.
5.  **Deployment Script Generation (`InfrastructureAgent`)**:
    *   Generates `scripts/deploy.sh` (serves as both a manual deployment option and the basis for the CodeBuild execution logic):
        *   Takes environment argument.
        *   Reads parameter file.
        *   Builds frontend.
        *   Syncs frontend build to S3.
        *   Invalidates CloudFront Cache.
        *   Handles backend deployment (Chalice or CFN).
        *   Deploys/Updates the main CFN stack.
        *   Includes basic error checking.
6.  **Standard File Generation (`OrchestratorAgent`)**:
    *   Generates a standard `.gitignore` file suitable for Python (Chalice), Node.js (React), and common OS/IDE files.
    *   Generates a default `LICENSE` file (e.g., MIT License text).
7.  **README Generation (`OrchestratorAgent` / `InfrastructureAgent`)**:
    *   Generates `README.md` within the defined structure:
        *   Includes Project Structure, Prerequisites, Local Dev Setup, Manual Deployment Instructions (`scripts/deploy.sh`), CI/CD Pipeline Overview (how it works, triggers), and Accessing the Application.
8.  **Final Validation (`OrchestratorAgent`)**: Performs a final check of the structure, scripts, README, generated standard files, and CI/CD configuration logic.

## 6. Output

*   **Complete Project Directory:** A directory adhering to the **Opinionated Project Structure**, containing:
    *   Frontend source code (`frontend/`)
    *   Backend source code (`backend/`)
    *   Infrastructure definition (`infrastructure/template.yaml` - including CI/CD resources)
    *   Parameter files (`infrastructure/parameters/`)
    *   Deployment script (`scripts/deploy.sh`)
    *   `README.md`
    *   `.gitignore`
    *   `LICENSE`
    *   Local dev config (`samconfig.toml`, `.env.example`)
    *   Test stubs (`tests/`)

## 7. Best Practices / Constraints Enforcement

*   **Defined Structure:** Project MUST follow the specified directory layout.
*   **IaC Completeness:** Final CFN template MUST define all application and basic CI/CD resources.
*   **Automated CI/CD:** A basic, deployable CI/CD pipeline definition (CodePipeline/CodeBuild) MUST be included in the CloudFormation template.
*   **Automation & Configuration:** Deployment (manual script and CI/CD) MUST use environment-specific parameter files.
*   **Cache Invalidation:** Deployment logic MUST include CloudFront cache invalidation.
*   **Local Dev Ready:** Project MUST include necessary files and README instructions for local development setup.
*   **Standard Files:** Project MUST include standard `.gitignore` and `LICENSE` files.
*   **Clarity:** README MUST be comprehensive and accurate. 